<?php//$iz = true;//$gorod_price="Москва";//error_reporting(E_ALL);//ini_set('display_errors', true);//ini_set('error_reporting',  E_ALL);include_once("../_common/setup.php");include_once("a.charset.php");include 'my_function.php';include 'PHPExcel.php';include 'PHPExcel/Writer/Excel5.php';include 'PHPExcel/Reader/Excel5.php';include_once 'PHPExcel/IOFactory.php';$gorod_price=$_POST['town']; //город ИЗ$kol = $_POST['kol']; //количество городов$priceizcreate = $_POST['priceizcreate']; //нужно ли делать прайс ИЗ города (true - не надо, false - надо)$actualdate = $_POST['actualdate']; //дата актуальности прайс-листовecho 'Из города <b>'.$gorod_price.'</b><br>';echo 'Всего городов - <b>'.$kol.'</b><br><br>';$j=0;for ($i=1; $i<=$kol; $i++){	$gorodV = $_POST['gorod'.$i.''];	if ($gorodV<>''){		$j++;		echo $gorodV."<br>";		$goroda_v[$j]=$gorodV;	}}if ($priceizcreate==true){	echo 'Число городов к изменению - <b>'.$j.'</b><br><br>';}else{	echo 'Число городов к изменению - <b>'.($j+1).'</b><br><br>';	if (set_actual_date($gorod_price,$actualdate,true)){		echo "<p>[+] Дата актуальности в прайс-листе ИЗ города ".$gorod_price." успешно обновлена.</p>";	}else{		echo "<p>[-] Дата актуальности в прайс-листе ИЗ города ".$gorod_price." НЕ обновлена.</p>";	}	generate_pricelist($gorod_price,true); }// СОЗДАЕМ ПРАЙС ИЗ ГОРОДАfor ($h=1; $h<=count($goroda_v); $h++){	if (set_actual_date($goroda_v[$h],$actualdate,false)){		echo "<p>[+] Дата актуальности в прайс-листе В город ".$goroda_v[$h]." успешно обновлена.</p>";	}else{		echo "<p>[-] Дата актуальности в прайс-листе В город ".$goroda_v[$h]." НЕ обновлена.</p>";	}	generate_pricelist($goroda_v[$h],false); //ПРАЙС(Ы) В ГОРОДА}function generate_pricelist($gorod_price,$iz){/*$variant1 = translate_ch($_POST['iz']); translate_ch($variant2 = $_POST['v']);if ($variant1 == true){$iz = true;}if ($variant2 == true){$iz = false;}*///$array = array(    //array('amount'=>'<500','amount'=>1,'amount'=>2,'amount'=>3,'amount'=>4,'amount'=>5,'amount'=>6,'amount'=>7,'amount'=>8,'amount'=>9,'amount'=>10,'amount'=>11,'amount'=>12,'amount'=>13),//);//////////////////////ВЕС$zagolovki_naimenovaniy_ves = array(    array('amount1'=>'<500','amount2'=>'500','amount3'=>'1000','amount4'=>'2000','amount5'=>'3000','amount6'=>'4000','amount7'=>'5000','amount8'=>'6000','amount9'=>'7000','amount10'=>'8000','amount11'=>'9000','amount12'=>'10000','amount13'=>'15000','amount14'=>'20000'),);/////////////////////ОБЪЕМ$zagolovki_naimenovaniy_ob = array(    array('amount1'=>'<1','amount2'=>'1','amount3'=>'2','amount4'=>'4','amount5'=>'6','amount6'=>'8','amount7'=>'10','amount8'=>'12','amount9'=>'14','amount10'=>'16','amount11'=>'18','amount12'=>'20','amount13'=>'30','amount14'=>'40'),);$columns_zagolovki = array(	'D'=>array('index'=>'amount1'),	'E'=>array('index'=>'amount2'),	'F'=>array('index'=>'amount3'),	'G'=>array('index'=>'amount4'),	'H'=>array('index'=>'amount5'),	'I'=>array('index'=>'amount6'),	'J'=>array('index'=>'amount7'),	'K'=>array('index'=>'amount8'),	'L'=>array('index'=>'amount9'),	'M'=>array('index'=>'amount10'),	'N'=>array('index'=>'amount11'),	'O'=>array('index'=>'amount12'),	'P'=>array('index'=>'amount13'),	'Q'=>array('index'=>'amount14'),);////////////////////////////////////////$objReader = new PHPExcel_Reader_Excel5();////////////////ПРОВЕРКА НАЛИЧИЯ ШАБЛОНАif ($iz==true){$filename = 'tpl/'.translit($gorod_price).'IZtpl.xls';echo $filename;if (file_exists($filename)) {    $objPHPExcel = $objReader->load('tpl/'.translit($gorod_price).'IZtpl.xls');	$obj = PHPExcel_IOFactory::load('tpl/'.translit($gorod_price).'IZtpl.xls'); //	echo '<p>Шаблон прайса найден.</p>';} else {	$objPHPExcel = $objReader->load('tpl/template.xls');	$obj = PHPExcel_IOFactory::load('tpl/template.xls'); //    echo '<p>Шаблон прайса не найден. Подгружаем общий.</p>';}}if ($iz==false){$filename = 'tpl/'.translit($gorod_price).'Vtpl.xls';echo $filename;if (file_exists($filename)) {    $objPHPExcel = $objReader->load('tpl/'.translit($gorod_price).'Vtpl.xls');	$obj = PHPExcel_IOFactory::load('tpl/'.translit($gorod_price).'Vtpl.xls');	echo '<p>Шаблон прайса найден.</p>';} else {	$objPHPExcel = $objReader->load('tpl/template.xls');	$obj = PHPExcel_IOFactory::load('tpl/template.xls'); //    echo '<p>Шаблон прайса не найден. Подгружаем общий.</p>';}}////////////КОНЕЦ ПРОВЕРКИ НАЛИЧИ ШАБЛОНА$objWorksheet1 = $objPHPExcel->getActiveSheet()->copy();$objWorksheet1->setTitle('Pricelist');//$objPHPExcel->addSheet($objWorksheet1);$objPHPExcel->setActiveSheetIndex(0);//$objPHPExcel->removeSheetByIndex(0);//// $sheet = $objPHPExcel->setActiveSheetIndex(0);filial_info_shapka($objPHPExcel,$gorod_price,$iz,1,'ves');$r = 3; //Первая строка после шапки//$sheet->setCellValue('A'.$r,'Название данного документа');//Устанавливаем значение ячейки//$sheet->getStyle('A'.$r)->getFont()->setBold(true)->setSize(20);//Устанавливаем стиль ячейки //'B'=>array('index'=>'title','title'=>'NAME','width'=>40),$columns = array(	'A'=>array('index'=>'amount1'),	'B'=>array('index'=>'amount2'),	'C'=>array('index'=>'amount3'),	'D'=>array('index'=>'amount4'),	'E'=>array('index'=>'amount5'),	'F'=>array('index'=>'amount6'),	'G'=>array('index'=>'amount7'),	'H'=>array('index'=>'amount8'),	'I'=>array('index'=>'amount9'),	'J'=>array('index'=>'amount10'),	'K'=>array('index'=>'amount11'),	'L'=>array('index'=>'amount12'),	'M'=>array('index'=>'amount13'),	'N'=>array('index'=>'amount14'),	'O'=>array('index'=>'amount15'),	'P'=>array('index'=>'amount16'),	'Q'=>array('index'=>'amount17'),	'R'=>array('index'=>'amount18'),		//'S'=>array('index'=>'amount19'),	//'T'=>array('index'=>'amount20'),); //Теперь начнем заполнять данными (ВЕС)$firstrow = $r;$r=$r+1;foreach($zagolovki_naimenovaniy_ves as $row) {    foreach($columns_zagolovki as $key => $column) {        $sheet->setCellValue($key.$r,$row[$column['index']]);		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);    }    $r++;}$r=$firstrow+2;//////////////////////////// Формируем лист (ВЕС)if ($iz==true){	$iz_v="ArrivalName";	$query = 'SELECT * FROM prices WHERE DepartureName="'.$gorod_price.'" ORDER BY ArrivalName ASC';}else{	$iz_v="DepartureName";	$query = 'SELECT * FROM prices WHERE ArrivalName="'.$gorod_price.'" ORDER BY DepartureName ASC';}		//if (mb_check_encoding($query, 'Windows-1251') && !mb_check_encoding($query, 'UTF-8'))        //$query = mb_convert_encoding($query, 'UTF-8', 'Windows-1251');$results = mysql_query($query);while ($line = mysql_fetch_assoc($results)) {$query_tel = mysql_fetch_assoc(mysql_query('SELECT only_tel_number FROM filial_info WHERE filial="'.$line["$iz_v"].'"'));if ($query_tel==''){	$query_tel_parent = mysql_fetch_assoc(mysql_query('SELECT only_tel_number FROM filial_info WHERE filial="'.$gorod_price.'"'));	$query_tel['only_tel_number']=$query_tel_parent['only_tel_number'];}$on_center=false;$array = array(    array('amount1'=>translate_ch($line[$iz_v]),'amount2'=>translate_ch($line["VagonType"]),'amount3'=>$line["minkg"],'amount4'=>$line["kg_200"],'amount5'=>$line["kg_500"],'amount6'=>$line["kg_1000"],'amount7'=>$line["kg_2000"],'amount8'=>$line["kg_3000"],'amount9'=>$line["kg_4000"],'amount10'=>$line["kg_5000"],'amount11'=>$line["kg_6000"],'amount12'=>$line["kg_7000"],'amount13'=>$line["kg_8000"],'amount14'=>$line["kg_9000"],'amount15'=>$line["kg_10000"],'amount16'=>$line["kg_15000"],'amount17'=>$line["kg_20000"],'amount18'=>$query_tel["only_tel_number"]));foreach($array as $row) {    foreach($columns as $key => $column) {        $sheet->setCellValue($key.$r,$row[$column['index']]);		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getFont()->setBold(true)->setSize(9);		if (($on_center==true) and ($key<>'R')){		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);				}		$on_center=true;    }    $r++;  }}////////////////////////////$lastrow = $r;$objPHPExcel->getActiveSheet()->getStyle('A'.($firstrow+2).':B'.($lastrow-1))->getNumberFormat()->setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_TEXT);$objPHPExcel->getActiveSheet()->getStyle('D'.($firstrow+2).':R'.($lastrow-1))->getNumberFormat()->setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_NUMBER_00); // ЧИСЛОВОЙ ФАРМАТ ДАННЫХgranica('A'.$firstrow,'R'.($lastrow-1),$objPHPExcel); // РАМКА$r++;$firstrow = $r+2;filial_info_shapka($objPHPExcel,$gorod_price,$iz,$r,'ob');$r=$r+3;foreach($zagolovki_naimenovaniy_ob as $row) {    foreach($columns_zagolovki as $key => $column) {        $sheet->setCellValue($key.$r,$row[$column['index']]);		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);    }    $r++;}$objPHPExcel->getActiveSheet()->setBreak( 'A'.($r-5), PHPExcel_Worksheet::BREAK_ROW );//////////////////////////// Формируем лист (Объем)$on_center=false;if ($iz==true){$query = 'SELECT * FROM prices WHERE DepartureName="'.$gorod_price.'" ORDER BY ArrivalName ASC';}else{$query = 'SELECT * FROM prices WHERE ArrivalName="'.$gorod_price.'" ORDER BY DepartureName ASC';}//if (mb_check_encoding($query, 'Windows-1251') && !mb_check_encoding($query, 'UTF-8'))  //      $query = mb_convert_encoding($query, 'UTF-8', 'Windows-1251');$results = mysql_query($query);while ($line = mysql_fetch_assoc($results)) {$query_tel = mysql_fetch_assoc(mysql_query('SELECT only_tel_number FROM filial_info WHERE filial="'.$line["$iz_v"].'"'));if ($query_tel==''){	$query_tel_parent = mysql_fetch_assoc(mysql_query('SELECT only_tel_number FROM filial_info WHERE filial="'.$gorod_price.'"'));	$query_tel['only_tel_number']=$query_tel_parent['only_tel_number'];}$on_center=false;$array = array(    array('amount1'=>translate_ch($line[$iz_v]),'amount2'=>translate_ch($line["VagonType"]),'amount3'=>$line["minkg"],'amount4'=>$line["kub_0_4"],'amount5'=>$line["kub_1"],'amount6'=>$line["kub_2"],'amount7'=>$line["kub_4"],'amount8'=>$line["kub_6"],'amount9'=>$line["kub_8"],'amount10'=>$line["kub_10"],'amount11'=>$line["kub_12"],'amount12'=>$line["kub_14"],'amount13'=>$line["kub_16"],'amount14'=>$line["kub_18"],'amount15'=>$line["kub_20"],'amount16'=>$line["kub_30"],'amount17'=>$line["kub_40"],'amount18'=>$query_tel["only_tel_number"]));foreach($array as $row) {    foreach($columns as $key => $column) {        $sheet->setCellValue($key.$r,$row[$column['index']]);		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getFont()->setBold(true)->setSize(9);		if (($on_center==true) and ($key<>'R')){		$objPHPExcel->setActiveSheetIndex(0)->getStyle($key.$r)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);		}		$on_center=true;    }    $r++;  }}$objPHPExcel->getActiveSheet()->setBreak( 'A'.($r-1), PHPExcel_Worksheet::BREAK_ROW );////////////////////////////$lastrow = $r;granica('A'.$firstrow,'R'.($lastrow-1),$objPHPExcel); // РАМКА//////////////////////////// ПРИМЕЧАНИЯ #################################$activeSheet = $obj->setActiveSheetIndex(1); //$activeSheet = $obj->getActiveSheet();$i = 0; //foreach($activeSheet->getRowIterator() as $row){    $i++;	$objPHPExcel->getActiveSheet()->mergeCells('A'.$r.':R'.$r);	$crew_template = $activeSheet->getStyle('A'.$i);	$objPHPExcel->setActiveSheetIndex(0)->duplicateStyle($crew_template,'A'.$r);	$objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.$r, $activeSheet->getCell('A' . $i)->getValue());	$objPHPExcel->getActiveSheet()->getRowDimension($r)->setRowHeight(11);	if (strlen($activeSheet->getCell('A' . $i)->getValue())>320){ //ЕСЛИ ДЛИНА СТРОКИ БОЛЬШЕ ЗАДАННОГО, ТО УВЕЛИЧ. ВЫСОТУ	$objPHPExcel->getActiveSheet()->getRowDimension($r)->setRowHeight(22);	}	$r++;}			$objPHPExcel->removeSheetByIndex(1);////////////////////////////############################################$objWriter = new PHPExcel_Writer_Excel5($objPHPExcel);if ($iz == true){backup_price(translit($gorod_price.'ИЗ'),'prices/'.translit($gorod_price.'ИЗ').'.xls','prices/'.translit($gorod_price.'ИЗ').'.zip'); /// СОЗДАЕМ КОПИИ ПРАЙСОВ$objWriter->save('prices/'.translit($gorod_price.'ИЗ').'.xls');//file_add_archive('prices/'.translit($gorod_price.'ИЗ').'.xls','prices/'.translit($gorod_price.'ИЗ'),translit($gorod_price.'ИЗ').'.xls');// СОЗДАЕМ АРХИВadd_to_archive_new('prices/'.translit($gorod_price.'ИЗ').'.xls','prices/'.translit($gorod_price.'ИЗ'));// СОЗДАЕМ АРХИВecho 'Прайс из города '.$gorod_price.' сделан.<br>-------------------------------------------<br>'; // ВЫВОДИМ СООБЩЕНИЯ О ЗАВЕРШЕНИИ} else{backup_price(translit($gorod_price.'В'),'prices/'.translit($gorod_price.'В').'.xls','prices/'.translit($gorod_price.'В').'.zip'); /// СОЗДАЕМ КОПИИ ПРАЙСОВ$objWriter->save('prices/'.translit($gorod_price.'В').'.xls');//file_add_archive('prices/'.translit($gorod_price.'В').'.xls','prices/'.translit($gorod_price.'В'),translit($gorod_price.'В').'.xls');// СОЗДАЕМ АРХИВadd_to_archive_new('prices/'.translit($gorod_price.'В').'.xls','prices/'.translit($gorod_price.'В'));// СОЗДАЕМ АРХИВecho 'Прайс в город '.$gorod_price.' сделан.<br>-------------------------------------------<br>'; // ВЫВОДИМ СООБЩЕНИЯ О ЗАВЕРШЕНИИ}}?><a href='create_price.php'>Назад</a> <?php ?>